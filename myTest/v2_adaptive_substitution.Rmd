---
title: "Adaptive Substitution Analysis"
author: "Hanxi Sun"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# setwd("~/GoogleDrive/Purdue/Research/Vinayak_Rao/17Spr_Genetic/Softwares/myPhast/R code/")
```

## Get Adaptive Substitution
```{r}
# read .fasta
fa <- readLines("../myTest/hmrc.fa")

# preprocessing
sp.loc <- which(startsWith(fa, '> ')) # species names locations in .fasta file
num_row <- sp.loc[2] - sp.loc[1] - 1  # num of rows of sequ for each species
sequ <- sapply(split(fa[-sp.loc],     # DNA sequences
                     rep(1:length(sp.loc), each=num_row)), 
               function(x) strsplit(paste(x, collapse = ''), ''))
sequ <- do.call(cbind.data.frame, sequ)
sp.name <- sapply(fa[sp.loc],         # species names 
                  function(x) substring(x, 3))
colnames(sequ) <- sp.name

# adaptive substitution locations
### count for all adaptive substitutions
as.loc <- which((sequ$human != sequ$mouse) & (sequ$mouse == sequ$rat) & (sequ$mouse == sequ$cow))
### no insertion (other species = '-')
as.loc1 <- which((sequ$human != sequ$mouse) & (sequ$mouse == sequ$rat) & (sequ$mouse == sequ$cow) & (sequ$mouse != '-'))
### no insertion or deletion
as.loc2 <- which((sequ$human != sequ$mouse) & (sequ$mouse == sequ$rat) & (sequ$mouse == sequ$cow) & (sequ$mouse != '-') &  (sequ$human != '-'))
```



## Preprocessing DLESS output (.gff)

```{r}
# abbrev types to 'conserve', 'death' or 'acc'
type.abbrev <- function(t){
    sapply(as.character(t), function(x){a<-unlist(strsplit(x, '-')); a[length(a)]})
    # t1 <- sapply(as.character(t), function(x){a<-unlist(strsplit(x, '-')); a[length(a)]})
    # t1[t1 %in% c('death', 'conserved')] <- 'con'
}

# the original output (rho=0.3, phi=0.5)
df <- read.table("../myTest/original_hmrc.gff", skip=3)
gff0 <- df[,c("V3","V4","V5")]
colnames(gff0) <- c("type", "start", "end")
gff0$type.ab <- type.abbrev(gff0$type)

# output from 
# ../bin/dless --acc-height 2 --lambda 2.5 --phi 0.2 --eta 0.3 hmrc.fa hky.mod > v2_accH.gff
df <- read.table("../myTest/v2_accH.gff", skip=3)
gff <- df[,c("V3","V4","V5")]
colnames(gff) <- c("type", "start", "end")
gff$type.ab <- type.abbrev(gff$type)

```


## Plots
```{r}
library(ggplot2)
# pdf('v2_test_1.pdf')
orig.y <- 50; new.y <- 150 # y loc for the labels
plot.h <- 
    ggplot(as.data.frame(as.loc), aes(as.loc)) +
    geom_histogram(bins = 50) + 
    geom_segment(aes(x = start, y = orig.y, 
                     xend = end, yend = orig.y,
                     colour = type.ab), 
                 size = 3, data = gff0)+ 
    geom_segment(aes(x = start, y = new.y, 
                     xend = end, yend = new.y,
                     colour = type.ab), 
                 size = 3, data = gff) + 
    labs(x = 'Location', title = 'adaptive sub counts with insertion & deletion') +
    geom_label(data = data.frame(x = rep(5000, 2), 
                                y = c(orig.y, new.y), 
                                lab = c("original", "with acc")),
              aes(x,y,label = lab), fill = 'lightsteelblue4', colour = "white", fontface = "bold")
plot.h
# dev.off()

# pdf('v2_test_2.pdf')
orig.y <- 3; new.y <- 9
plot.h <- 
    ggplot(as.data.frame(as.loc1), aes(as.loc1)) +
    geom_histogram(bins = 50) + 
    geom_segment(aes(x = start, y = orig.y, 
                     xend = end, yend = orig.y,
                     colour = type.ab), 
                 size = 3, data = gff0)+ 
    geom_segment(aes(x = start, y = new.y, 
                     xend = end, yend = new.y,
                     colour = type.ab), 
                 size = 3, data = gff) + 
    labs(x = 'Location', title = 'adaptive sub counts with only deletion') +
    geom_label(data = data.frame(x = rep(5000, 2), 
                                 y = c(orig.y, new.y), 
                                 lab = c("original", "with acc")),
               aes(x,y,label = lab), fill = 'lightsteelblue4', colour = "white", fontface = "bold") +
    xlim(0, max(as.loc1))
plot.h
# dev.off()

# pdf('v2_test_3.pdf')
orig.y <- 2; new.y <- 7
plot.h <- 
    ggplot(as.data.frame(as.loc2), aes(as.loc2)) +
    geom_histogram(bins = 50) + 
    geom_segment(aes(x = start, y = orig.y, 
                     xend = end, yend = orig.y,
                     colour = type.ab), 
                 size = 3, data = gff0)+ 
    geom_segment(aes(x = start, y = new.y, 
                     xend = end, yend = new.y,
                     colour = type.ab), 
                 size = 3, data = gff) + 
    labs(x = 'Location', title = 'adaptive sub counts without insertion or deletion') +
    geom_label(data = data.frame(x = rep(5000, 2), 
                                 y = c(orig.y, new.y), 
                                 lab = c("original", "with acc")),
               aes(x,y,label = lab), fill = 'lightsteelblue4', colour = "white", fontface = "bold") +
    xlim(0, max(as.loc1))
plot.h
# dev.off()
```


## Tests
```{r}
# preprocessing AS & Neutral
as <- as1 <- as2 <- rep('AS', nrow(sequ))
as[as.loc] <- as1[as.loc1] <- as2[as.loc2] <- 'nonAS'
neutral <- neutral0 <- rep('Neutral', nrow(sequ))
neutral[Reduce(c, 
               apply(cbind(gff$start, gff$end), 1, 
                     function(x) x[1]:x[2]))] <- 'nonNeutral'
neutral0[Reduce(c, 
                apply(cbind(gff0$start, gff0$end), 1, 
                      function(x) x[1]:x[2]))] <- 'nonNeutral'

prop.test(table(neutral0, as))  # original output & all AS
prop.test(table(neutral, as))   # new output & all AS

prop.test(table(neutral0, as1)) # original output & AS w/o deletion
prop.test(table(neutral, as1))  # new output & AS w/o deletion

prop.test(table(neutral0, as2)) # original output & AS w/o deletion or insertion
prop.test(table(neutral, as2))  # new output & AS w/o deletion or insertion

```
